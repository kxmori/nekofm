"use strict";function MainCtrl(n,t,i,r,u){t.$on("$routeChangeStart",function(){n.loading=!0;Debug.log("Start "+i.path())});t.$on("$routeChangeSuccess",function(){if(n.loading=!1,n.newLocation=i.path(),Debug.log("Success "+i.path()),i.path()=="/radio/search"){Debug.log("けんさく文字列: ["+n.query+"]");var t=i.search();n.query="?"+t.q}});t.$on("$routeChangeError",function(){n.loading=!1;Debug.log("Error "+i.path());i.path()=="/radio"&&i.path("/radio/list")});t.$on("serviceCallStart",function(){n.loading=!0});t.$on("serviceCallEnd",function(){n.loading=!1});t.$on("MusicChanged",function(n,i){t.title=i.title+" - "+i.artist});n.$on("StationListChanged",function(){i.path()!="/radio/list"&&i.path("/radio/list");n.station=r.station()});n.$on("StationChanged",function(){n.station=r.station()});n.brand=u;n.Math=window.Math;n.station=r.station();n.playContext=r.playContext();n.trackSearch=!1;n.dt=new Date;n.doSearch=function(t){t&&n.trackSearch&&(n.trackSearch=!1);var u=t||n.query;n.trackSearch||u.charAt(0)=="?"||u.charAt(0)=="？"?(u=u.replace(/^[?？]*/g,""),u.length>0&&i.path("/radio/search").search({q:u,p:1})):u.length>0&&r.create(u)};n.toggleSearch=function(){n.trackSearch=!n.trackSearch;n.query&&(n.query=n.query.replace(/^[?？]*/g,""),n.trackSearch&&n.query.length>0&&(n.query="?"+n.query))};n.placeHolder=function(){return n.trackSearch?"Search For Music":"Create a New Station"};n.focusCreate=function(){n.trackSearch=!1;n.query="";$(".search-query").focus()};n.debug=function(){r.debug()};n.setBusy=function(){n.loading=!0};n.clearBusy=function(){n.loading=!1};n.checkWelcome=function(){return n.newLocation=="/radio"?"wide":""};n.checkUnknown=function(n){return n?n.artist=="_"?!0:!1:!1};n.stationName=function(){return n.station?n.station.name:""}}function SearchResultCtrl(n,t,i){Debug.log("けんさくけっかーーーーーーーーーーーーーーー");Debug.dir(i);n.results=i;n.checkNext=function(){return n.results.page<parseInt((n.results.totalResults-1)/30)+1};n.play=function(i){var r=n.results.tracks[i];t.playNow(r.artist,r.title)}}function PlayerCtrl(n,t,i){Debug.log("ぷれーやーーーーーーーーーーーーーーーー");n.settings=i.playerSettings();n.toggleFade=function(){n.settings.crossFade=!n.settings.crossFade;n.settings.crossFade&&n.settings.repeat&&(n.settings.repeat=!1);i.playerSettings(n.settings)};n.toggleRepeat=function(){n.settings.crossFade||(n.settings.repeat=!n.settings.repeat,i.playerSettings(n.settings))};n.show=!0;n.toggleShow=function(){n.show=!n.show};n.eyeIcon=function(){return n.show?"icon-eye-close":"icon-eye-open"};n.eyeTitle=function(){return n.show?"Hide YouTube Player":"Show YouTube Player"};n.checkReady=function(){return n.playContext.playerState&&n.playContext.playerState!=-1};n.doPause=function(){i.pause()};n.doNext=function(){i.doNext()};n.addFavorite=function(){i.addFavorite();t.path("/radio/favorite")};n.addDonot=function(){i.addDonot();i.doNext()};n.editing=!1;n.$on("MusicChanged",function(){n.editing=!1});n.startEditing=function(){if(n.editing){n.editing=!1;return}var t=i.getVideoId();t?(n.videoId=t.id,n.stSec=t.stSec):(n.videoId=null,n.stSec=null);n.errorMessage="";n.editing=!0};n.doAdjust=function(){var r,t;if(n.videoId!=null){if(n.videoId.length==0){i.setVideoId(null,n.videoId,n.stSec);n.editing=!1;return}if(r=i.getPlaybackStatus(),r.videoId==t){i.setVideoId(null,n.videoId,n.stSec);n.editing=!1;return}t=n.videoId.replace(/(^\s+)|(\s+$)/g,"");i.getVideoTitle(t,function(){i.setVideoId(null,t,n.stSec);n.$apply(n.onLostFocus)},function(t){n.$apply(function(){n.errorMessage=t})})}};n.onLostFocus=function(){n.editing=!1};n.onSetStartSec=function(){var t=i.getPlaybackStatus();t&&(n.stSec=t.currentTime,n.videoId=t.videoId)};n.onResetStartSec=function(){n.stSec=null};n.changed=function(){n.errorMessage=""};n.dontPlay=function(){i.addDonotById();i.doNext();n.editing=!1}}function StationListCtrl(n,t,i){function r(r){Debug.log("すてーしょんりすとーーーーーーーーーーーーーーー");n.stationList=angular.copy(i.stationList());Debug.log("stationListの長さ"+Object.keys(n.stationList).length);Object.keys(n.stationList).length==0&&t.path("/radio");for(var u in n.stationList)r!=null&&r==u?(n.stationList[u].editing=!0,Debug.log("StationList 編集 : "+u)):n.stationList[u].editing=!1}r();n.$on("StationListChanged",function(n,t){r(t)});n.startEditing=function(t){n.stationList[t].editing=!0};n.doRename=function(t){var r=n.stationList[t].name.replace(/(^\s+)|(\s+$)/g,"");r.length>0?i.renameStation(t,r):n.stationList[t].name=angular.copy(i.stationList()[t].name);n.stationList[t].editing=!1};n.onLostFocus=function(t){n.stationList[t].name=angular.copy(i.stationList()[t].name);n.stationList[t].editing=!1};n.changeStation=function(r){n.stationList[r].name==n.stationName()?t.path("radio/config"):i.changeStation(r)};n.removeStation=function(t){window.confirm("Are you sure you want to remove the following station?\n\n"+n.stationList[t].name)&&i.removeStation(t)};n.newStation=function(){n.focusCreate()}}function ArtistDetailCtrl(n,t,i){Debug.log("あーてぃすとしょうさいーーーーーーーーーーーーーーー");n.artist=i;n.play=function(i){t.playNow(n.artist.name,n.artist.songs[i].name)};n.$on("artistSongsUpdate",function(){n.clearBusy()});n.getMoreSongs=function(){n.setBusy();t.getTracks(n.artist)};n.setSongCount=function(i){t.setSongCount(n.artist,i+1)};n.getSongCount=function(){return t.getSongCount(n.artist)}}function ArtistTracksCtrl(n,t,i){Debug.log("あーてぃすと　とらっくーーーーーーーーーーーーーーー");n.artist=i;n.play=function(i){t.playNow(n.artist.name,n.artist.songs[i].name)};n.$on("artistSongsUpdate",function(){n.clearBusy()});n.getMoreSongs=function(){n.setBusy();t.getTracks(n.artist)}}function ConfigCtrl(n,t,i,r){Debug.log("こんふぃぐーーーーーーーーーーーーーーー");n.artists=r.artists;n.addArtist=function(){i.addArtist(n.newArtist,10)};n.removeArtist=function(n){i.removeArtist(n,1)};n.dirty=!1;n.changed=function(){n.dirty||(n.dirty=!0,t(function(){i.doSaveStation();n.dirty=!1},3e3))};n.thumbsUp=function(t){n.artists[t].match<10&&(n.artists[t].match++,n.changed())};n.thumbsDown=function(t){n.artists[t].match>0&&(n.artists[t].match--,n.changed())};n.artists.forEach(function(n){n.editing=!1});n.startEditing=function(t){n.artists[t].editing=!0};n.doAdjust=function(t){n.artists[t].editing=!1};n.onLostFocus=function(t){n.artists[t].editing=!1}}function SongHistoryCtrl(n,t,i){Debug.log("ひすとりーーーーーーーーーーーーーーー");n.history=i;n.play=function(i){var r=n.history[i];t.playNow(r.artist,r.title)}}function FavoriteListCtrl(n,t,i){Debug.log("おきにいりーーーーーーーーーーーーーーー");n.favorites=i;n.playIcon=function(i){if(n.station){var r=t.getStationId().id;return i.tags.indexOf(r)!=-1?"img/Music-Green.png":"img/Music-Grey.png"}};n.togglePlay=function(i){if(n.station){var r=t.getStationId().id;i.tags.indexOf(r)!=-1?t.removeFavorite(i):t.addFavorite(i)}};n.checkStation=function(){return n.station?!0:!1};n.play=function(n){t.playNow(n.artist,n.title)};n.remove=function(n){t.removeFavorite(n,!0)};n.playAll=function(){t.playFavorites()};n.editing=!1;n.startEditing=function(){if(n.editing){n.editing=!1;return}n.videoId="";n.track={artist:"",title:""};n.errorMessage="";n.editing=!0};n.add=function(){t.addFavoriteAs(n.videoId,n.track,function(){n.$apply(n.onLostFocus)},function(t){n.$apply(function(){n.errorMessage=t})})};n.onLostFocus=function(){n.editing=!1};n.changed=function(){n.errorMessage=""}}function DonotListCtrl(n,t,i){Debug.log("再生しないでーーーーーーーーーーーーーーー");n.donots=i;n.play=function(n){t.playNow(n.artist,n.title)};n.remove=function(n){t.removeDonot(n)}}function AudioscrobblerService(n){this.getSimilarArtists=function(t,i,r,u){var f="http://ws.audioscrobbler.com/2.0/?method=artist.getsimilar&artist="+encodeURIComponent(t)+"&limit="+i.toString()+"&autocorrect=1&api_key=031d7fac215b370e7179b8354a2f7f77&format=json&callback=JSON_CALLBACK";n.jsonp(f).success(r).error(function(n,t,i,r){Debug.error("$http.jsonp error [artist.getsimilar]\n\n"+r.url);u!=null&&u()})};this.getTopTracks=function(t,i,r,u,f){var e="http://ws.audioscrobbler.com/2.0/?method=artist.gettoptracks&artist="+encodeURIComponent(t)+"&page="+i.toString()+"&limit="+r.toString()+"&api_key=031d7fac215b370e7179b8354a2f7f77&format=json&callback=JSON_CALLBACK";n.jsonp(e).success(u).error(function(n,t,i,r){Debug.error("$http.jsonp error [artist.gettoptracks]\n\n"+r.url);f!=null&&f()})};this.searchTrack=function(t,i,r,u,f){var e="http://ws.audioscrobbler.com/2.0/?method=track.search&track="+encodeURIComponent(t)+"&page="+i.toString()+"&limit="+r.toString()+"&api_key=031d7fac215b370e7179b8354a2f7f77&format=json&callback=JSON_CALLBACK";n.jsonp(e).success(u).error(function(n,t,i,r){Debug.error("$http.jsonp error [track.search]\n\n"+r.url);f!=null&&f()})};this.getInfo=function(t,i,r){var u="http://ws.audioscrobbler.com/2.0/?method=artist.getInfo&artist="+encodeURIComponent(t)+"&autocorrect=1&api_key=031d7fac215b370e7179b8354a2f7f77&format=json&callback=JSON_CALLBACK";n.jsonp(u).success(i).error(function(n,t,i,u){Debug.error("$http.jsonp error [artist.getInfo]\n\n"+u.url);r!=null&&r()})};this.getArtist=function(t,i,r){var u="http://ws.audioscrobbler.com/2.0/?method=artist.search&artist="+encodeURIComponent(t)+"&api_key=031d7fac215b370e7179b8354a2f7f77&format=json&callback=JSON_CALLBACK";n.jsonp(u).success(i).error(function(n,t,i,u){Debug.error("$http.jsonp error [artist.search]\n\n"+u.url);r!=null&&r()})}}function YouTubeService(n){function t(t,i,r,u){var f,e;i?f=t.artist.indexOf(" ")!=-1?'"'+t.artist+'" '+t.title:t.artist+" "+t.title:(f=t.artist+" "+t.title,f=f.replace(/(\(.*\)|\[.*\])/g,""));e="https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoEmbeddable=true&q="+encodeURIComponent(f)+"&key=AIzaSyDTgBSjmchn_levHkOLJm-d6AfhIBOTPWU&callback=JSON_CALLBACK";n.jsonp(e).success(function(n){Debug.log("youtube video search: ["+f+"]");r(n)}).error(function(n,t,i,r){Debug.error("$http.jsonp error [youtube videoSearch]\n\n"+r.url);u!=null&&u()})}this.videoSearch=function(n,i,r){t(n,!0,i,r)};this.getInfo=function(n,t,i){var r="https://www.googleapis.com/youtube/v3/videos/?part=snippet&id="+n+"&key=AIzaSyDTgBSjmchn_levHkOLJm-d6AfhIBOTPWU";$.ajax({url:r,cache:!1,success:function(n){t&&t(n)},error:function(n){Debug.dir(n);i&&i(n.status)}})}}function YouTubePlayer(n,t,i){function p(t){if(t.target==r?(t.target.setVolume(100),t.target.ready=!0):(t.target.setVolume(100),t.target.ready=!0),r.ready&&u.ready){var i=r.getAvailablePlaybackRates();Debug.log("YouTube Player playbackRates=",i);l=i.length>1;Debug.info("----------",l?"HTML5 Player":"Flash Player");Debug.info("---status player:"+r.getPlayerState()+"  playerSub:"+u.getPlayerState());n&&n();e&&(o=window.setTimeout(h,1e3))}}function w(n){if(n.target==r)Debug.info("player status ("+n.data+")"),e&&f!=-1&&(Debug.info("----- playerSub="+u.getPlayerState()),n.data==2&&u.getPlayerState()!=2&&window.setTimeout(function(){r.getPlayerState()==2&&(Debug.info("----- pauseが押されたと判断した"),u.pauseVideo(),u.paused=!0)},400),n.data==1&&u.getPlayerState()!=1&&(u.playVideo(),u.paused=!1),n.data==0&&u.paused&&(Debug.info("----- pauseが押されたと判断したのは間違いだった"),u.playVideo(),u.paused=!1)),t&&t(n.data);else{Debug.info("playerSub status ("+n.data+")");var i=s[n.data];i&&i()}}function a(n,t,i){Debug.assert(n&&t&&i,"waitStateChange: illegal parameter");s[n]=function(){window.clearTimeout(r);delete s[n];t()};var r=window.setTimeout(function(){delete s[n];i()},4e3)}function b(n){n.target==r?(Debug.error("onPlayerError at player: "+n.data),i&&i(n.data)):Debug.error("onPlayerError at playerSub: "+n.data)}function h(){var n=r.getCurrentTime(),t=r.getDuration()-11;n>=t&&r.getPlayerState()==1&&(u.getPlayerState()==2||u.getPlayerState()==5)?(f=r.isMuted()?u.getVolume():r.getVolume(),u.setVolume(0),Debug.log("ーーもうすぐクロスフェイド開始ーー volumebak=",f),u.playVideo(),Debug.log(">>>>>>> 1 待ち "),a(1,function(){Debug.log("ーーーークロスフェイド開始ーーーー volumebak=",f);o=window.setTimeout(k,100)},function(){Debug.log("<<<<<<< 1 タイムアウト")})):o=window.setTimeout(h,1e3)}function k(){var n=r.getVolume();n>0&&(r.getPlayerState()==1&&(n-=f/10,Debug.log("volume="+n),r.setVolume(n),u.setVolume(f-n)),o=window.setTimeout(k,1e3))}function g(){e&&(u.getPlayerState()!=5&&window.setTimeout(function(){t&&t(1)},0),v(),o=window.setTimeout(h,1e3))}function v(){window.clearTimeout(o);f!=-1&&(r.setVolume(f),u.setVolume(f),Debug.log("ーーーークロスフェイド終了ーーーー volumebak=",f+", vol="+r.getVolume()),f=-1)}function d(){Debug.log("プレーヤー切り替え");nt();r.getPlayerState()!=1&&r.playVideo();g()}function nt(){var n=r;r=u;u=n;document.getElementById(u.f.id).style.position!="static"&&(document.getElementById(r.f.id).style.position="absolute",document.getElementById(r.f.id).style.left=0,document.getElementById(u.f.id).style.position="static")}var y=document.createElement("script"),c,r,u,e,o,f,l,s;y.src="https://www.youtube.com/player_api";c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(y,c);f=-1;s={};window.onYouTubePlayerAPIReady=function(){r=new YT.Player("player1",{height:"230",width:"350",playerVars:{rel:0,wmode:"opaque"},events:{onReady:p,onStateChange:w,onError:b}});u=new YT.Player("player2",{height:"230",width:"350",playerVars:{rel:0,wmode:"opaque"},events:{onReady:p,onStateChange:w,onError:b}})};this.playVideo=function(n,t){e&&(u.getPlayerState()==1&&(u.seekTo(0),u.pauseVideo()),v(),o=window.setTimeout(h,1e3));r.loadVideoById(n,t)};this.cueVideo=function(n,t,i){function r(){i&&i()}l?(u.mute(),u.cueVideoById(n,t),Debug.log(">>>>>>> 5 待ち "),a(5,function(){u.playVideo();Debug.log(">>>>>>> 1 待ち ");a(1,function(){u.pauseVideo();u.unMute();r()},function(){Debug.log("<<<<<<< 1 タイムアウト");u.pauseVideo();u.unMute();r()})},function(){Debug.log("<<<<<<< 5 タイムアウト");u.unMute();r()})):(u.cueVideoById(n,t),r())};this.doNext=function(){if(r.getPlayerState()==1&&r.pauseVideo(),e&&f!=-1)d();else{var n=r.getVolume();d();n!=0&&r.setVolume(n)}};this.rewind=function(){r.seekTo(0)};this.pause=function(){e&&f!=-1?r.getPlayerState()==1?(r.pauseVideo(),u.getPlayerState()==1&&u.pauseVideo()):(r.playVideo(),u.getPlayerState()==2&&u.playVideo()):r.getPlayerState()==1?r.pauseVideo():r.playVideo()};this.stop=function(){r.stopVideo()};this.cancel=function(){r.stopVideo();u.stopVideo()};this.playbackStatus=function(){var n=r.getVideoUrl(),i=r.getDuration(),u=r.getVideoEmbedCode(),f=r.getCurrentTime(),t;return(Debug.log("------getVideoUrl "+n),Debug.log("------getDuration "+i),Debug.log("------getVideoEmbedCode "+u),t=n.lastIndexOf("="),t==-1)?null:{videoId:n.substr(t+1),currentTime:f}};this.crossFade=function(n){e!=n&&(e=n,r&&u&&r.ready&&u.ready&&(e?o=window.setTimeout(h,1e3):v()))};this.debug=function(){document.getElementById(r.f.id).style.position!="absolute"?(document.getElementById(r.f.id).style.position="absolute",document.getElementById(r.f.id).style.left=0):document.getElementById(r.f.id).style.position="static"}}angular.module("myRadio",["radioServices"]).constant("Brand","Neko.fm").config(["$routeProvider",function(n){n.when("/radio",{templateUrl:"partials/welcome.html",resolve:{url:["$q","Radio",function(n,t){var i=n.defer();return t.isEmpty()?i.resolve("/radio"):i.reject("/radio/list"),i.promise}]}}).when("/radio/search",{templateUrl:"partials/search-result.html",controller:SearchResultCtrl,resolve:{results:["$q","$location","Radio",function(n,t,i){var r=n.defer(),u=t.search();return i.search(u.q,parseInt(u.p),function(n){r.resolve(n)},function(){r.reject("Server error")}),r.promise}]}}).when("/radio/artist/:name",{templateUrl:"partials/artist-tracks.html",controller:ArtistTracksCtrl,resolve:{artist:["$q","$route","Radio",function(n,t,i){var r=n.defer(),u=t.current.params.name;return i.getArtistProfile(u,function(n){r.resolve(n)},function(){r.reject("Server error")}),r.promise}]}}).when("/radio/config",{templateUrl:"partials/config.html",controller:ConfigCtrl,resolve:{station:["$q","Radio",function(n,t){var i=n.defer(),r=t.station();return r?i.resolve(r):i.reject("station not yet open"),i.promise}]}}).when("/radio/config/:artistId",{templateUrl:"partials/artist-detail.html",controller:ArtistDetailCtrl,resolve:{artist:["$q","$route","Radio",function(n,t,i){var r=n.defer(),u=i.getArtistDetail(t.current.params.artistId);return u?r.resolve(u):r.reject("illegal index"),r.promise}]}}).when("/radio/list",{templateUrl:"partials/station-list.html",controller:StationListCtrl}).when("/radio/history",{templateUrl:"partials/song-history.html",controller:SongHistoryCtrl,resolve:{history:["$q","Radio",function(n,t){var i=n.defer(),r=t.history();return r.length==0&&t.isEmpty()?i.reject("history is empty"):i.resolve(r),i.promise}]}}).when("/radio/favorite",{templateUrl:"partials/favorite-list.html",controller:FavoriteListCtrl,resolve:{favorites:["$q","Radio",function(n,t){var i=n.defer(),r=t.favorites();return r.length==0&&t.isEmpty()?i.reject("favorites is empty"):i.resolve(r),i.promise}]}}).when("/radio/donot",{templateUrl:"partials/donot-list.html",controller:DonotListCtrl,resolve:{donots:["$q","Radio",function(n,t){var i=n.defer(),r=t.donots();return r.length==0&&t.isEmpty()?i.reject("donots is empty"):i.resolve(r),i.promise}]}}).otherwise({redirectTo:"/radio"})}]);MainCtrl.$inject=["$scope","$rootScope","$location","Radio","Brand"];SearchResultCtrl.$inject=["$scope","Radio","results"];PlayerCtrl.$inject=["$scope","$location","Radio"];StationListCtrl.$inject=["$scope","$location","Radio"];ArtistDetailCtrl.$inject=["$scope","Radio","artist"];ArtistTracksCtrl.$inject=["$scope","Radio","artist"];ConfigCtrl.$inject=["$scope","$timeout","Radio","station"];SongHistoryCtrl.$inject=["$scope","Radio","history"];FavoriteListCtrl.$inject=["$scope","Radio","favorites"];DonotListCtrl.$inject=["$scope","Radio","donots"];angular.module("ng").directive("ngFocus",["$timeout",function(n){return{link:function(t,i,r){t.$watch(r.ngFocus,function(t){angular.isDefined(t)&&t&&n(function(){i[0].focus()})},!0);i.bind("blur",function(){angular.isDefined(r.ngFocusLost)&&t.$apply(r.ngFocusLost)})}}}]);angular.module("radioServices",[]).constant("API_KEY","031d7fac215b370e7179b8354a2f7f77").factory("Radio",["$rootScope","$http","$q",function(n,t){function ct(n){k(rt,n)==-1&&(rt.push(n),rt.length>kt&&rt.shift());r.artists.forEach(function(t){if(t.name==n.artist){var i=dt(t.songs,n.title);i>-1&&(t.songs[i].forbidden=!0)}})}function lt(n,t){var i,r;for(Debug.assert(typeof t=="string","searchArtist: artist must be string"),i=0;i<n.length;i++)if(r=n[i],r.name==t)return i;return-1}function dt(n,t){var i,r;for(Debug.assert(typeof t=="string","searchTitle: title must be string"),i=0;i<n.length;i++)if(r=n[i],r.name==t)return i;return-1}function k(n,t){var i,r;for(Debug.assert(typeof t=="object","searchTrack: track must be object"),i=0;i<n.length;i++)if((r=n[i],r.artist==t.artist&&r.title==t.title)||r.hasOwnProperty("videoId")&&t.hasOwnProperty("videoId")&&r.videoId==t.videoId)return i;return-1}function tt(){if(u.stationId==null)return null;var n=u.stationId.indexOf(".");return{id:u.stationId.substr(0,n),name:u.stationId.substr(n+1)}}function ft(){if(u.stationId==null)return null;var n=u.stationId.indexOf(".");return u.stationId.substr(n+1)}function gt(){var n,t,i;for(w={},n=0;n<localStorage.length;n++)Debug.log("localStorage key["+n+"] = "+localStorage.key(n)),t=localStorage.key(n),t.charAt(0)!="$"&&(i=t.indexOf("."),w[t.substr(0,i)]={name:t.substr(i+1)})}function ni(){var n;gt();n=localStorage.getItem("$settings");u=JSON.parse(n);u==null&&(u={});n=localStorage.getItem("$history");h=JSON.parse(n);h==null&&(h=[]);n=localStorage.getItem("$favorites");f=JSON.parse(n);f==null&&(f=[]);n=localStorage.getItem("$donots");p=JSON.parse(n);p==null&&(p=[]);n=localStorage.getItem("$idmap");l=JSON.parse(n);l==null&&(l={});u.stationId!=null&&(n=localStorage.getItem(u.stationId),r=JSON.parse(n),r==null?(delete u.stationId,b()):r.name=ft());a=new YouTubePlayer(function(){r&&ot()},fi,ei);u.crossFade=u.crossFade||!1;u.repeat=u.repeat||!1;a.crossFade(u.crossFade);Debug.dir(u);Debug.dir(r);Debug.dir(f);Debug.dir(p);Debug.dir(l)}function it(){var n,t;Debug.assert(u.stationId,"unset settings.stationId");n={artists:[]};r.artists.forEach(function(t){var i={name:t.name,match:t.match};t.songCount&&t.songCount!=v&&(i.songCount=t.songCount);n.artists.push(i)});t=angular.toJson(n);localStorage.setItem(u.stationId,t)}function b(){var n=angular.toJson(u);localStorage.setItem("$settings",n)}function ti(){var n=angular.toJson(h);localStorage.setItem("$history",n)}function et(){var n=angular.toJson(f);localStorage.setItem("$favorites",n)}function at(){var n=angular.toJson(p);localStorage.setItem("$donots",n)}function ii(){var n=angular.toJson(l);localStorage.setItem("$idmap",n)}function ri(){r.artists.length=0;localStorage.clear()}function vt(n,t,i,r){function f(){nt.getArtist(n,function(f){if(Debug.dir(f),f.error!=null){Debug.error("artist.search error:"+f.error+"["+f.message+"]");r&&r();return}var e=f.results.artistmatches.artist;if(e==null){Debug.error("この名前のアーティストはいない ["+n+"]");r&&r();return}n=e[0]!=null?e[0].name:e.name;u(n,t,i,r)})}function u(n,t,i,r){Debug.assert(i,"getSimilar: onSuccess is null!");nt.getSimilarArtists(n,t,function(t){var f,u,e;if(t.error!=null){Debug.error("getSimilar error "+t.error+" ("+t.message+") ["+n+"]");r!=null&&r();return}Debug.dir(t.similarartists);f=[];u=t.similarartists.artist;u instanceof Array?(n=t.similarartists["@attr"].artist,u.unshift({name:n,match:1}),u.forEach(function(n){var t=Math.ceil(parseFloat(n.match)*10),i={name:n.name,match:t,songs:[]};f.push(i)})):typeof u=="string"&&(e={name:u,match:10,songs:[]},f.push(e));i!=null&&i(f)})}u(n,t,i,f)}function ot(n){function u(u){++t;Debug.log("readyCount "+t+": "+u.name+" "+u.songs.length+"songs");n?u.name==r.artists[0].name&&u.songs.length>0?(s({artist:u.name,title:u.songs[0].name},c.playCue),i=!0):t!=15||i||s(y(),c.playCue):(t==1&&s(y(),c.play),t==f&&s(y(),c.cue))}function e(n,t){window.setTimeout(function(){g(n,t)},Math.floor(Math.random()*3e4));u(n)}var i=!1,t=0,f=r.artists.length;r.artists.forEach(function(n){n.songs=n.songs||[];var t=n.songCount||v;t%v!=0&&(t=Math.ceil(t/v)*v);g(n,t,u,e)})}function ui(n){for(var t=n;t<r.artists.length;t++)g(r.artists[t],v,function(n){Debug.log("@"+n.name+" "+n.songs.length+"songs")},function(n,t){window.setTimeout(function(){g(n,t)},3e3);Debug.log("@"+n.name+" "+n.songs.length+"songs")})}function g(n,t,i,r){Debug.assert(t%v==0&&n.songs.length%t==0,"getTopTracks: illegal count="+t);var u=Math.floor(n.songs.length/t)+1,f=t;nt.getTopTracks(n.name,u,f,function(r){var u,f,e;if(r.error!=null)Debug.error("getTopTracks: "+r.error+" (artist="+n.name+")\n\n"+r.message);else if(r.toptracks==null)Debug.error("getTopTracks error: toptracks is undefined");else if(u=r.toptracks.track,u&&u.length>0){for(f=0;f<u.length;f++)n.songs.push({name:u[f].name,playcount:u[f].playcount});e=r.toptracks["@attr"].total;n.maxout=n.songs.length>=e}else n.songs.push({name:u.name||"_",playcount:u.playcount||1}),n.maxout=!0;i&&i(n,t)},function(){r&&r(n,t)})}function y(){function w(n){var i,t,r,u;if(Debug.assert(n.length>0,"artists are empty"),t=0,n.forEach(function(n){n.songs!=null&&n.songs.length>0&&(t+=parseFloat(n.match))}),t==0)return null;r=Math.random()*t;t=0;u=-1;do i=n[++u],i.songs.length>0&&(t+=parseFloat(i.match));while(t<=r);return i}function b(n){var i,t,r,u;if(Debug.assert(n.length>0,"songs are empty"),t=0,n.forEach(function(n){n.forbidden||(t+=parseInt(n.playcount))}),t==0)return null;r=Math.floor(Math.random()*t);t=0;u=-1;do i=n[++u],i.forbidden||(t+=parseInt(i.playcount));while(t<=r);return i}var c,a,n,s,t;if(o!=null&&o.length>0)return c=o.shift(),o.push(c),c;Debug.assert(r,"station not yet open");var l={artist:"Bach",title:"Air"},i=[],u=0,n={name:"$favorites",match:10,songs:[]};for(f.forEach(function(t){t.tags.indexOf(tt().id)!=-1&&(n.songs.push({artist:t.artist,name:t.title,playcount:1}),++u)}),n.songCount=u,i.push(n),Debug.log("お気に入りのきょくすう : ",u),r.artists.forEach(function(n){var r,t,f;if(n.match>0)for(i.push(n),r=Math.min(n.songs.length,n.songCount||v),t=0;t<r;t++)f=n.songs[t],f.forbidden||++u}),Debug.log("きょくすう : ",u),a=h.slice(0,Math.min(h.length,u-1));i.length>0;){if(n=w(i),n==null)return l;var e=[],y=n.songs,p=Math.min(y.length,n.songCount||v);for(s=0;s<p;s++)t=y[s],e.push({artist:t.artist||n.name,title:t.name,playcount:t.playcount,forbidden:t.forbidden});if(e=e.diff(a,k),e.length>0){if(t=b(e),t!=null)return Debug.log("getNextSong: ["+t.artist+" - "+t.title+"]"),t}else Debug.log("曲が０になったぞ！！！！ : "+n.name);i.splice(i.indexOf(n),1)}return l}function s(t,i,r){function f(i,r){r!=c.cue?(a.playVideo(i.id,i.stSec),e.trackPlay={artist:t.artist,title:t.title,videoId:i.id},pt(e.trackPlay),n.title=e.trackPlay.title+" - "+e.trackPlay.artist,Debug.info("loadVideoById ("+i.id+") ["+i.title+"]"),r==c.playCue&&s(y(),c.cue)):a.cueVideo(i.id,i.stSec,function(){e.trackCue={artist:t.artist,title:t.title,videoId:i.id};Debug.info("cueVideoById ("+i.id+")  YouTube title ["+i.title+"]");n.$$phase||n.$apply()})}var o=t.artist+"-"+t.title,u=l[o];if(u!=null&&u.id.length>0){Debug.assert(u.id.length>0,"cueVideo: video ID is empty!");f({id:u.id,stSec:u.stSec},i);return}if(i!=c.play&&k(p,t)>-1){Debug.error(" 再生禁止！ ["+t.artist+" - "+t.title+"]");ct(t);s(y(),i);return}st.videoSearch(t,function(n){var u=n,r,e,o,h;if(u==null||u.pageInfo.totalResults==0){Debug.error(" エントリがない ["+t.artist+" - "+t.title+"]");ct(t);s(y(),i);return}for(r=0,e=r;u.items[r].snippet.title.indexOf("てみた")!=-1;)if(Debug.error(u.items[r].snippet.title),++r>=u.length){r=e;s(y(),i);return}o=u.items[r].id.videoId;h=u.items[r].snippet.title;f({id:o,title:h},i)},function(){r||s(y(),i,!0)})}function fi(t){Debug.log("すてーとチェンジドーーー["+t+"]");e.playerState=t;e.isPlaying=t==1;n.$$phase||n.$apply();t==0&&(u.repeat?a.rewind():yt())}function ei(n){n==5}function yt(t){e.trackCue?(a.doNext(t),e.trackPlay=e.trackCue,e.trackCue=null,pt(e.trackPlay),n.$broadcast("MusicChanged",e.trackPlay),r&&s(y(),c.cue)):r&&s(y(),c.play)}function pt(n){Debug.assert(n,"setHistory: track is null!");h.unshift({artist:n.artist,title:n.title});h.length>ht&&h.pop();ti()}function wt(n){var i=k(f,n),r,u,t;if(i>=0){if(t=tt(),t){if(r=t.id,f[i].tags.indexOf(r)>=0)return;f[i].tags.push(r)}}else u={artist:n.artist,title:n.title,tags:[]},t=tt(),t&&u.tags.push(t.id),f.unshift(u);et()}function bt(n){k(p,n)==-1&&(p.unshift(n),at())}function oi(){f.forEach(function(n){n.thumbnail==null&&nt.getInfo(n.artist,function(t){if(Debug.dir(t),t.error!=null){Debug.error("artist.search error:"+t.error+"["+t.message+"]");return}n.thumbnail=t.artist.image[0]["#text"];Debug.log("サムネイル : ",n.thumbnail)})})}var i={},nt=new AudioscrobblerService(t),st=new YouTubeService(t),a,r,e={},w,u={},h=[],f=[],p=[],l={},rt=[],o,v=50,ht=100,kt=ht+20,c={cue:0,play:1,playCue:2},d,ut;return i.getVideoId=function(n){n==null&&(n=h[0]);var t=n.artist+"-"+n.title;return l[t]},i.setVideoId=function(n,t,i){function f(n){for(var t in l)if(n==l[t].id)return t;return null}var r,u;n==null&&(n=h[0]);r=n.artist+"-"+n.title;t==null||t.length==0?delete l[r]:(u=f(t),u!=null&&delete l[u],l[r]={id:t},i&&(l[r].stSec=i));s(n,c.play);ii()},i.station=function(){return r},i.stationList=function(){return w},i.isEmpty=function(){return Object.keys(w).length==0},i.renameStation=function(n,t){var i=n+"."+w[n].name,f=n+"."+t,e;f!=i&&(w[n].name=t,e=localStorage.getItem(i),localStorage.setItem(f,e),localStorage.removeItem(i),u.stationId==i&&(u.stationId=f,b(),r.name=ft()))},i.changeStation=function(t){var i=t+"."+w[t].name,f;(o!=null||i!=u.stationId)&&(u.stationId=i,b(),o&&(o=null),f=localStorage.getItem(u.stationId),r=JSON.parse(f),r==null?(delete u.stationId,b()):r.name=ft(),e.trackCue=null,ot(),n.$broadcast("StationChanged"))},i.removeStation=function(t){f.forEach(function(n){var i=n.tags.indexOf(t);i!=-1&&n.tags.splice(i,1)});var i=t+"."+w[t].name;localStorage.removeItem(i);delete w[t];i==u.stationId?(delete u.stationId,b(),r=null,a.stop(),e.trackCue=null,n.$broadcast("StationListChanged")):n.$broadcast("StationListChanged")},i.getStationId=function(){return tt()},ni(),d={},i.search=function(n,t,i,r){nt.searchTrack(n,t,30,function(r){Debug.dir(r);var u=r.results.trackmatches.track;d.query=n;d.page=t;d.tracks=[];d.totalResults=parseInt(r.results["opensearch:totalResults"]);u!=null&&(u instanceof Array?u.forEach(function(n){d.tracks.push({artist:n.artist,title:n.name})}):d.tracks.push({artist:u.artist,title:u.name}));i&&i(d)},function(){r&&r()})},i.getArtistDetail=function(n){return!r||isNaN(n)||n>=r.artists.length?null:r.artists[n]},ut={},i.getArtistProfile=function(n,t,i){var u;r&&(u=lt(r.artists,n))!=-1?t&&t(r.artists[u]):(ut.name=n,ut.songs=[],g(ut,v,function(n){t&&t(n)},function(){i&&i()}))},i.create=function(t){vt(t,30,function(i){if(i.length>0){o&&(o=null);t=i[0].name;r={artists:[],name:t};i.forEach(function(n){r.artists.push(n)});var f=Math.round((new Date).getTime()/1e3).toString();u.stationId=f+"."+t;b();it();ot(!0);w[f]={name:t};n.$broadcast("StationListChanged",f)}})},i.addArtist=function(n,t){var i=r.artists.length;vt(n,t,function(n){n.length>0&&(n.forEach(function(n){var t;if((t=lt(r.artists,n.name))>=0){r.artists[t].match=Math.max(n.match,r.artists[t].match);return}r.artists.push(n)}),ui(i),it())})},i.removeArtist=function(n,t){r.artists.splice(n,t);it()},i.clearArtists=function(){a.cancel();ri()},i.getTracks=function(t){g(t,v,function(t){n.$broadcast("artistSongsUpdate",t)},function(){})},i.setSongCount=function(n,t){n.songCount=t;it()},i.getSongCount=function(n){return Math.min(n.songs.length,n.songCount?n.songCount:v)},i.doSaveStation=function(){it();Debug.log("saved!")},Array.prototype.diff=function(n,t){return this.filter(function(i){return!(t(n,i)>-1)})},i.doNext=function(){yt(!0)},i.pause=function(){a.pause()},i.getPlaybackStatus=function(){return a.playbackStatus()},i.playNow=function(n,t){s({artist:n,title:t},c.play)},i.artists=function(){return r.artists},i.playContext=function(){return e},i.history=function(){return h},i.favorites=function(){return f},i.addFavorite=function(n){n==null&&(n=h[0]);wt(n)},i.addFavoriteAs=function(n,t,r,u){Debug.assert(r&&u,"addFavoriteAs: success & error function required");i.getVideoTitle(n,function(u){(t==null||t.title.length==0)&&(t={artist:"_",title:u});k(f,t)==-1&&(wt(t),i.setVideoId(t,n));r(t)},function(n){u(n)})},i.getVideoTitle=function(n,t,i){Debug.assert(t&&i,"getVideoTitle: success & error function required");st.getInfo(n,function(r){var u=r.entry,f;if(Debug.dir(u),u==null){Debug.error(" エントリがない ["+n+"]");i("Video not found");return}if(u.yt$noembed!=null){Debug.error("埋め込み拒否動画 ("+n+") ["+u.title.$t+"]");i("Embedding disabled by request");return}f=u.title.$t;t(f)},function(n){n=="400"||n=="404"?i("Video not found"):i("server error")})},i.removeFavorite=function(n,t){var r,i;t?(r=k(f,n),f.splice(r,1),et()):(i=n.tags.indexOf(tt().id),i!=-1&&(n.tags.splice(i,1),et()))},i.donots=function(){return p},i.addDonot=function(n){n==null&&(n=h[0]);bt(n)},i.addDonotById=function(n){n==null&&(n=e.trackPlay.videoId);i.getVideoTitle(n,function(t){var i={artist:"_",title:t,videoId:n};bt(i)},function(){})},i.removeDonot=function(n){var t=k(p,n);p.splice(t,1);at()},i.playFavorites=function(){var t,i,e;if(f.length!=0&&o==null){for(delete u.stationId,b(),r=null,n.$broadcast("StationChanged"),o=angular.copy(f),t=o.length;--t;)i=Math.floor(Math.random()*(t+1)),e=o[t],o[t]=o[i],o[i]=e;s(y(),c.play);s(y(),c.cue)}},i.readThumbnails=function(){oi()},i.playerSettings=function(n){return n&&(Debug.assert(!(n.crossFade&&n.repeat),"can't set enable crossFade & repeat at the same time"),n.hasOwnProperty("crossFade")&&(u.crossFade=n.crossFade,b(),a.crossFade(n.crossFade)),n.hasOwnProperty("repeat")&&(u.repeat=n.repeat,b())),{crossFade:u.crossFade,repeat:u.repeat}},i.debug=function(){a.debug()},i}]);